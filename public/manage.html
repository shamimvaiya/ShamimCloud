<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Project | Shamim Cloud</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <script>
        tailwind.config = {
            theme: { extend: { colors: { dark: '#030712', primary: '#7c3aed', secondary: '#db2777' }, fontFamily: { sans: ['Outfit', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] } } }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400&display=swap');

        body {
            background-color: #030712;
            color: #e2e8f0;
            font-family: 'Outfit', sans-serif;
            overflow-x: hidden;
        }

        .glass {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            border-color: #7c3aed;
            transform: translateY(-3px);
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #68D391;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <nav class="sticky top-0 z-30 w-full glass border-b border-gray-800/50">
        <div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2 text-gray-400 hover:text-white transition group">
                <div
                    class="w-8 h-8 rounded-lg bg-gray-800 flex items-center justify-center group-hover:bg-primary transition">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <span class="font-bold">Back to Dashboard</span>
            </a>
            <div class="flex items-center gap-3">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <span class="text-xs font-mono text-gray-400">CONSOLE ACTIVE</span>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-6xl mx-auto px-4 py-8 w-full">

        <div
            class="flex flex-col md:flex-row justify-between items-start md:items-end mb-10 gap-6 animate__animated animate__fadeInDown">
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <div class="p-2 rounded bg-primary/20 text-primary"><i class="fab fa-html5 text-2xl"></i></div>
                    <h1 id="projName" class="text-4xl font-extrabold text-white tracking-tight">Loading...</h1>
                </div>
                <a id="projLink" href="#" target="_blank"
                    class="text-blue-400 hover:text-blue-300 font-mono text-sm flex items-center gap-2 hover:underline">
                    <i class="fas fa-external-link-alt"></i> <span id="urlText">checking url...</span>
                </a>
            </div>
            <div class="flex gap-3">
                <button onclick="downloadZip()" id="btn-download-zip"
                    class="p-3 bg-gray-800 hover:bg-gray-700 rounded-xl transition text-gray-300 hover:text-white relative"
                    title="Download Source">
                    <i class="fas fa-file-archive"></i>
                </button>
                <button onclick="window.location.reload()"
                    class="p-3 bg-gray-800 hover:bg-gray-700 rounded-xl transition"><i
                        class="fas fa-sync-alt"></i></button>
                <button onclick="handleProjectAction('deploy')"
                    class="px-6 py-3 bg-primary hover:bg-primary/90 text-white font-bold rounded-xl shadow-lg transition">
                    <i class="fas fa-rocket mr-2"></i> Update Site
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8 animate__animated animate__fadeInUp">

            <div class="lg:col-span-2 space-y-6">
                <div class="glass rounded-2xl p-6 border-l-4 border-green-500">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-bold text-white">Project Status</h3>
                            <p class="text-sm text-gray-400">Control visibility and access.</p>
                        </div>
                        <div class="text-right">
                            <span id="statusBadge"
                                class="px-3 py-1 rounded-full bg-green-500/20 text-green-400 text-xs font-bold border border-green-500/30 uppercase">Active</span>
                        </div>
                    </div>
                    <div class="mt-6 flex items-center justify-between bg-gray-900/50 p-4 rounded-xl">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-full bg-orange-500/10 flex items-center justify-center text-orange-500">
                                <i class="fas fa-tools"></i>
                            </div>
                            <div>
                                <p class="font-bold text-sm text-gray-200 flex items-center gap-2">Maintenance Mode
                                    <span id="maintLockIcon" class="hidden text-xs text-red-500"
                                        title="Premium Feature"><i class="fas fa-lock"></i></span>
                                </p>
                                <p class="text-xs text-gray-500">Show a "Under Construction" page to visitors.</p>
                            </div>
                        </div>
                        <div
                            class="relative inline-block w-12 h-6 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="maintToggle"
                                class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                            <label for="maintToggle"
                                class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-700 cursor-pointer"></label>
                        </div>
                    </div>
                </div>

                <div class="glass rounded-2xl p-6 border border-red-900/30">
                    <h3 class="text-lg font-bold text-red-400 mb-4"><i
                            class="fas fa-exclamation-triangle mr-2"></i>Danger Zone</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button id="btn-archive-project" onclick="handleProjectAction('archive')"
                            class="p-4 rounded-xl bg-gray-800 hover:bg-gray-700 border border-gray-700 text-left group transition relative">
                            <i id="icon-danger-archive"
                                class="fas fa-archive text-yellow-500 text-xl mb-2 group-hover:scale-110 transition-transform"></i>
                            <h4 id="text-danger-archive-title" class="font-bold text-gray-300">Archive Project</h4>
                            <p id="text-danger-archive-desc" class="text-xs text-gray-500">Disable without deleting.</p>
                        </button>
                        <button onclick="handleProjectAction('delete')"
                            class="p-4 rounded-xl bg-red-900/10 hover:bg-red-900/20 border border-red-900/30 text-left group transition">
                            <i
                                class="fas fa-trash-alt text-red-500 text-xl mb-2 group-hover:scale-110 transition-transform"></i>
                            <h4 class="font-bold text-red-400">Delete Project</h4>
                            <p class="text-xs text-red-300/50">Remove everything forever.</p>
                        </button>
                    </div>
                </div>
            </div>

            <div class="glass rounded-2xl p-6 h-full flex flex-col">
                <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-folder-open mr-2 text-primary"></i>File
                    Explorer</h3>
                <div id="fileList" class="flex-grow overflow-y-auto max-h-[400px] space-y-2 pr-2">
                    <div class="text-center py-10"><i class="fas fa-circle-notch fa-spin text-primary"></i> Loading
                        files...</div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between text-xs text-gray-400">
                    <span>Total Size:</span>
                    <span id="totalSize" class="text-white font-mono">...</span>
                </div>
            </div>
        </div>

    </main>

    <!-- CONFIRM MODAL (From Main File) -->


    <!-- EDIT MODAL (From Update File) -->
    <div id="editModal"
        class="fixed inset-0 z-50 hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="w-full max-w-4xl h-[80vh] glass bg-[#1e293b] rounded-2xl flex flex-col border border-gray-700">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-white font-bold flex items-center gap-2"><i class="fas fa-pen"></i> Editing: <span
                        id="editFileName" class="text-primary">...</span></h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-white"><i
                        class="fas fa-times"></i></button>
            </div>
            <textarea id="codeEditor"
                class="flex-grow bg-[#0f172a] text-gray-300 font-mono p-4 outline-none resize-none text-sm leading-relaxed"></textarea>
            <div class="p-4 border-t border-gray-700 flex justify-end gap-3">
                <button onclick="closeEditModal()"
                    class="px-4 py-2 rounded-lg bg-gray-700 text-white font-bold">Cancel</button>
                <button onclick="saveFileContent()" id="saveBtn"
                    class="px-6 py-2 rounded-lg bg-green-600 hover:bg-green-500 text-white font-bold">Save
                    Changes</button>
            </div>
        </div>
    </div>

    <!-- TOAST (From Main File) -->
    </div>

    <script src="js/ui-utils.js"></script>
    <script>
        // --- 1. INITIALIZATION ---
        const params = new URLSearchParams(window.location.search);
        const projectName = params.get('project');
        const user = JSON.parse(localStorage.getItem('shamim_user'));

        if (!user || !projectName) window.location.href = 'index.html';

        // Set Headers
        document.getElementById('projName').textContent = projectName;
        const liveUrl = `https://shamimvaiya.github.io/ShamimCloud/sites/${user.username}/${projectName}/`;
        document.getElementById('projLink').href = liveUrl;
        document.getElementById('projLink').href = liveUrl;
        document.getElementById('urlText').textContent = liveUrl;

        // ðŸ”¥ APPLY VISUAL LOCKS FOR FREE USERS ðŸ”¥
        if (user.plan === 'free') {
            // Lock ZIP Download
            const zipBtn = document.getElementById('btn-download-zip');
            if (zipBtn) {
                const lock = document.createElement('span');
                lock.className = "absolute -top-1 -right-1 bg-red-500 text-white text-[8px] px-1.5 py-0.5 rounded-full border border-[#030712]";
                lock.innerHTML = '<i class="fas fa-lock"></i>';
                zipBtn.appendChild(lock);
            }

            // Lock Archive Button
            const archiveBtn = document.getElementById('btn-archive-project');
            if (archiveBtn) {
                archiveBtn.classList.add('opacity-75', 'cursor-not-allowed');
                const title = document.getElementById('text-danger-archive-title');
                if (title) title.innerHTML = '<i class="fas fa-lock text-xs mr-1"></i> Archive (Locked)';
                // Note: The click handler creates a toast in handleProjectAction, so we don't need to override click here, 
                // just visual feedback is enough as per request to "Add Icon".
            }
        }

        // Lock Maintenance Visuals (VIP Check)
        if (user.plan !== 'vip_unlimited') {
            document.getElementById('maintLockIcon').classList.remove('hidden');
            document.getElementById('maintToggle').classList.add('opacity-50', 'cursor-not-allowed');
        }

        // Editor Variables
        let currentFileSha = null;
        let currentFilePath = null;

        // --- 2. LOAD DETAILS & FILES ---
        async function loadDetails() {
            try {
                const res = await fetch(`/api/project-details?username=${user.username}&project=${projectName}`);
                const data = await res.json();

                if (data.success) {
                    renderFiles(data.files);
                    document.getElementById('totalSize').textContent = (data.totalSize / 1024).toFixed(2) + ' KB';

                    // Check Maintenance State
                    const hasBackup = data.files.some(f => f.name === 'index_bak.html');
                    document.getElementById('maintToggle').checked = hasBackup;
                    updateStatus(hasBackup);

                    // Check Archive State (Integrated)
                    const isArchived = data.files.some(f => f.name === 'archived.html');
                    updateArchiveUI(isArchived);
                }
            } catch (e) { console.error(e); }
        }

        function updateArchiveUI(isArchived) {
            const statusBadge = document.getElementById('statusBadge');
            const dangerBtn = document.getElementById('btn-danger-archive');
            const dangerIcon = document.getElementById('icon-danger-archive');
            const dangerTitle = document.getElementById('text-danger-archive-title');
            const dangerDesc = document.getElementById('text-danger-archive-desc');

            if (!dangerBtn) return; // Guard clause

            if (isArchived) {
                // ARCHIVED STATE
                if (statusBadge) {
                    statusBadge.innerText = 'ARCHIVED';
                    statusBadge.className = 'px-3 py-1 rounded-full text-xs font-bold bg-yellow-500/10 text-yellow-500 border border-yellow-500/20';
                }

                dangerBtn.onclick = () => handleProjectAction('unarchive');
                dangerBtn.className = 'p-4 rounded-xl bg-green-900/10 hover:bg-green-900/20 border border-green-900/30 text-left group transition';

                dangerIcon.className = 'fas fa-trash-restore text-green-500 text-xl mb-2 group-hover:scale-110 transition-transform';
                dangerTitle.innerText = 'Restore Project';
                dangerTitle.className = 'font-bold text-green-400';
                dangerDesc.innerText = 'Site is currently offline.';
            } else {
                // ACTIVE STATE (Default Danger Zone)
                dangerBtn.onclick = () => handleProjectAction('archive');
                dangerBtn.className = 'p-4 rounded-xl bg-gray-800 hover:bg-gray-700 border border-gray-700 text-left group transition';

                dangerIcon.className = 'fas fa-archive text-yellow-500 text-xl mb-2 group-hover:scale-110 transition-transform';
                dangerTitle.innerText = 'Archive Project';
                dangerTitle.className = 'font-bold text-gray-300';
                dangerDesc.innerText = 'Disable without deleting.';
            }
        }
        // Removed separate checkArchiveStatus function as it was redundant

        function renderFiles(files) {
            const container = document.getElementById('fileList');
            container.innerHTML = '';

            files.forEach(f => {
                let icon = 'fa-file text-gray-400';
                if (f.name.endsWith('.html')) icon = 'fa-code text-orange-500';
                if (f.name.endsWith('.css')) icon = 'fa-paint-brush text-blue-500';
                if (f.name.endsWith('.js')) icon = 'fa-brands fa-js text-yellow-500';
                if (f.name.endsWith('.png') || f.name.endsWith('.jpg')) icon = 'fa-image text-purple-500';

                // Check if file is editable
                const isEditable = f.name.match(/\.(html|css|js|txt|json|md)$/i);

                container.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-gray-900/50 rounded-lg hover:bg-gray-800 transition group">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <i class="fas ${icon}"></i>
                            <span class="text-sm text-gray-300 truncate font-mono">${f.name}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-[10px] text-gray-600 group-hover:text-gray-400">${(f.size / 1024).toFixed(1)} KB</span>
                            ${isEditable ? `
                                <button onclick="openEditor('${f.path}', '${f.name}')" class="w-8 h-8 rounded bg-gray-700 hover:bg-primary text-gray-300 hover:text-white transition flex items-center justify-center" title="Edit File">
                                    <i class="fas fa-pen text-xs"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
        }

        // --- 3. EDITOR FUNCTIONS (From Update File) ---
        async function openEditor(path, name) {
            // ðŸ”¥ EDITOR RESTRICTION (Free Plan) ðŸ”¥
            const isFree = user.plan === 'free';

            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editFileName').innerText = name + (isFree ? ' (Read-Only)' : '');
            document.getElementById('codeEditor').value = 'Loading...';

            const saveBtn = document.getElementById('saveBtn');
            const editorArea = document.getElementById('codeEditor');

            if (isFree) {
                editorArea.readOnly = true;
                editorArea.classList.add('opacity-75', 'cursor-not-allowed');
                saveBtn.disabled = true;
                saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                saveBtn.classList.remove('hover:bg-green-500');
                saveBtn.innerText = "Locked (Pro Only)";
                showToast('Read-Only Mode: Upgrade to Edit.', 'error');
            } else {
                editorArea.readOnly = false;
                editorArea.classList.remove('opacity-75', 'cursor-not-allowed');
                saveBtn.disabled = false;
                saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                saveBtn.classList.add('hover:bg-green-500');
                saveBtn.innerText = "Save Changes";
            }

            currentFilePath = path;

            try {
                const res = await fetch('/api/get-file-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: path })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('codeEditor').value = data.content;
                    currentFileSha = data.sha;
                } else {
                    showToast('Error loading file');
                    closeEditModal();
                }
            } catch (e) {
                showToast('Server connection failed');
                closeEditModal();
            }
        }

        async function saveFileContent() {
            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerText;
            btn.innerText = 'Saving...'; btn.disabled = true;

            const content = document.getElementById('codeEditor').value;

            try {
                await fetch('/api/update-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: currentFilePath, content: content, sha: currentFileSha })
                });

                showToast('File Saved Successfully!');
                closeEditModal();
                loadDetails(); // Refresh list to update SHA
            } catch (e) {
                showToast('Failed to save file');
            } finally {
                btn.innerText = originalText; btn.disabled = false;
            }
        }

        function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }

        // --- 4. ACTIONS & MODALS ---
        async function handleProjectAction(action) {
            let title, desc, confirmText, isDestructive = false;

            if (action === 'delete') {
                title = 'Delete Project?';
                desc = 'âš ï¸ This will PERMANENTLY delete all files. Cannot be undone.';
                confirmText = 'Delete Forever';
                isDestructive = true;
            } else if (action === 'archive') {
                // ðŸ”¥ ARCHIVE RESTRICTION: PRO+ ONLY ðŸ”¥
                if (user.plan === 'free') {
                    showToast('Upgrade to PRO to Archive projects.', 'error');
                    return;
                }

                title = 'Archive Project?';
                desc = 'This will show a "Site Unavailable" page but keep files safe.';
                confirmText = 'Archive';
            } else if (action === 'unarchive') {
                title = 'Restore Project?';
                desc = 'This will make your site LIVE again.';
                confirmText = 'Restore';
                title = 'Restore Project?'; // Ensure correct title
            } else if (action === 'deploy') {
                title = 'Deploy New Version?';
                desc = 'This will overwrite existing files. Go to Dashboard to upload?';
                confirmText = 'Go to Dashboard';
            }

            if (!await openConfirm(title, desc, confirmText, isDestructive)) return;

            // Perform Action
            if (action === 'delete') {
                await performAction('/api/delete-project', { username: user.username, projectName: projectName });
                window.location.href = 'index.html';
            } else if (action === 'archive') {
                await performAction('/api/project-action', { username: user.username, project: projectName, action: 'archive' });
                showToast('Project archived. Reloading...');
                setTimeout(() => window.location.reload(), 1500);
            } else if (action === 'unarchive') {
                await performAction('/api/project-action', { username: user.username, project: projectName, action: 'unarchive' });
                showToast('Project Restored! Reloading...');
                setTimeout(() => window.location.reload(), 1500);
            } else if (action === 'deploy') {
                window.location.href = 'index.html';
            }
        }

        // Toggle Maintenance
        document.getElementById('maintToggle').addEventListener('click', async function (e) {
            // ðŸ”¥ MAINTENANCE RESTRICTION: VIP ONLY ðŸ”¥
            if (user.plan !== 'vip_unlimited') {
                e.preventDefault();
                showToast('Maintenance Mode is a VIP feature. Upgrade to Unlock.', 'error');
                return;
            }

            // Normal Logic if VIP
            const isChecked = this.checked;
            updateStatus(isChecked);

            const action = isChecked ? 'maintenance_on' : 'maintenance_off';
            showToast(isChecked ? 'Activating Maintenance Mode...' : 'Restoring Site...');

            await fetch('/api/project-action', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: user.username, project: projectName, action: action })
            });

            setTimeout(loadDetails, 2000); // Refresh file list
        });

        function updateStatus(isMaintenance) {
            const badge = document.getElementById('statusBadge');

            // ðŸ”¥ BADGE OVERRIDE FOR NON-VIP ðŸ”¥
            if (user.plan !== 'vip_unlimited') {
                badge.className = 'px-3 py-1 rounded-full bg-gray-700/50 text-gray-400 text-[10px] font-bold border border-gray-600 uppercase tracking-wide';
                badge.innerHTML = '<i class="fas fa-lock mr-1"></i> Upgrade to Unlock';
                return;
            }

            if (isMaintenance) {
                badge.className = 'px-3 py-1 rounded-full bg-orange-500/20 text-orange-400 text-xs font-bold border border-orange-500/30 uppercase';
                badge.textContent = 'Maintenance';
            } else {
                badge.className = 'px-3 py-1 rounded-full bg-green-500/20 text-green-400 text-xs font-bold border border-green-500/30 uppercase';
                badge.textContent = 'Active';
            }
        }

        async function performAction(url, body) {
            try {
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const data = await res.json();
                showToast(data.message || 'Action Completed');
                return data.success;
            } catch (e) { showToast('Error occurred'); return false; }
        }

        // ðŸ”¥ ZIP DOWNLOAD RESTRICTION ðŸ”¥
        function downloadZip() {
            if (user.plan === 'free') {
                showModal('Upgrade Required', 'Downloading source code is a PRO feature. <br><br>Upgrade now to access full backup & export tools.', 'View Plans', () => window.location.href = 'billing.html');
                return;
            }

            // Trigger Real Download
            showToast('Starting Download...', 'success');
            const downloadUrl = `/api/download-zip?username=${user.username}&project=${projectName}`;

            // Use iframe or window location. Window location is easiest for triggers.
            window.location.href = downloadUrl;
        }

        // Simple Modal Helper (Reusing OpenConfirm logic slightly or injecting new one? 
        // We have 'openConfirm' in ui-utils.js usually, but let's use a custom or just Toast if Modal unavailable.
        // Actually, let's use the openConfirm style but with header change.
        // Since ui-utils.js is blackbox here, better use showToast or build a simple alert.
        // Wait, the prompt asked for "Toast/Modal". I'll use a custom modal content injection if possible,
        // or just re-use the "confirm" modal but change texts. 
        // To be safe and compliant with "Toast/Modal" request:
        function showModal(title, msg, btnText, callback) {
            // Quick hack: Use the standard confirm modal structure if it exists, but since we don't have direct access to modify it easily without seeing ui-utils,
            // I will use a simple Alert Toast or just reuse openConfirm as a "Notice".
            // "openConfirm" usually returns a Promise. 
            // Let's just use existing openConfirm for simplicity but with specific text.
            openConfirm(title, msg, btnText).then(res => {
                if (res && callback) callback();
            });
        }



        loadDetails();
    </script>
</body>

</html>